<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="Apache Forrest" name="Generator">
<meta name="Forrest-version" content="0.9">
<meta name="Forrest-skin-name" content="pelt">
<title>DistCp Version 2 Guide</title>
<link type="text/css" href="skin/basic.css" rel="stylesheet">
<link media="screen" type="text/css" href="skin/screen.css" rel="stylesheet">
<link media="print" type="text/css" href="skin/print.css" rel="stylesheet">
<link type="text/css" href="skin/profile.css" rel="stylesheet">
<script src="skin/getBlank.js" language="javascript" type="text/javascript"></script><script src="skin/getMenu.js" language="javascript" type="text/javascript"></script><script src="skin/fontsize.js" language="javascript" type="text/javascript"></script>
<link rel="shortcut icon" href="images/favicon.ico">
</head>
<body onload="init()">
<script type="text/javascript">ndeSetTextSize();</script>
<div id="top">
<!--+
    |breadtrail
    +-->
<div class="breadtrail">
<a href="http://www.apache.org/">Apache</a> &gt; <a href="http://hadoop.apache.org/">Hadoop</a> &gt; <a href="http://hadoop.apache.org/core/">Core</a><script src="skin/breadcrumbs.js" language="JavaScript" type="text/javascript"></script>
</div>
<!--+
    |header
    +-->
<div class="header">
<!--+
    |start group logo
    +-->
<div class="grouplogo">
<a href="http://hadoop.apache.org/"><img class="logoImage" alt="Hadoop" src="images/hadoop-logo.jpg" title="Apache Hadoop"></a>
</div>
<!--+
    |end group logo
    +-->
<!--+
    |start Project Logo
    +-->
<div class="projectlogo">
<a href="http://hadoop.apache.org/core/"><img class="logoImage" alt="Hadoop" src="images/hadoop-logo-2.gif" title="Scalable Computing Platform"></a>
</div>
<!--+
    |end Project Logo
    +-->
<!--+
    |start Search
    +-->
<div class="searchbox">
<form action="http://www.google.com/search" method="get" class="roundtopsmall">
<input value="hadoop.apache.org" name="sitesearch" type="hidden"><input onFocus="getBlank (this, 'Search the site with google');" size="25" name="q" id="query" type="text" value="Search the site with google">&nbsp; 
                    <input name="Search" value="Search" type="submit">
</form>
</div>
<!--+
    |end search
    +-->
<!--+
    |start Tabs
    +-->
<ul id="tabs">
<li>
<a class="unselected" href="http://hadoop.apache.org/core/">Project</a>
</li>
<li>
<a class="unselected" href="http://wiki.apache.org/hadoop">Wiki</a>
</li>
<li class="current">
<a class="selected" href="index.html">Hadoop 1.2.1 Documentation</a>
</li>
</ul>
<!--+
    |end Tabs
    +-->
</div>
</div>
<div id="main">
<div id="publishedStrip">
<!--+
    |start Subtabs
    +-->
<div id="level2tabs"></div>
<!--+
    |end Endtabs
    +-->
<script type="text/javascript"><!--
document.write("Last Published: " + document.lastModified);
//  --></script>
</div>
<!--+
    |breadtrail
    +-->
<div class="breadtrail">

             &nbsp;
           </div>
<!--+
    |start Menu, mainarea
    +-->
<!--+
    |start Menu
    +-->
<div id="menu">
<div onclick="SwitchMenu('menu_1.1', 'skin/')" id="menu_1.1Title" class="menutitle">Getting Started</div>
<div id="menu_1.1" class="menuitemgroup">
<div class="menuitem">
<a href="index.html">Overview</a>
</div>
<div class="menuitem">
<a href="single_node_setup.html">Single Node Setup</a>
</div>
<div class="menuitem">
<a href="cluster_setup.html">Cluster Setup</a>
</div>
<div class="menuitem">
<a href="cli_minicluster.html">CLI MiniCluster</a>
</div>
</div>
<div onclick="SwitchMenu('menu_1.2', 'skin/')" id="menu_1.2Title" class="menutitle">Guides</div>
<div id="menu_1.2" class="menuitemgroup">
<div class="menuitem">
<a href="HttpAuthentication.html">Authentication for Hadoop HTTP web-consoles</a>
</div>
</div>
<div onclick="SwitchMenu('menu_selected_1.3', 'skin/')" id="menu_selected_1.3Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">MapReduce</div>
<div id="menu_selected_1.3" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="mapred_tutorial.html">MapReduce Tutorial</a>
</div>
<div class="menuitem">
<a href="streaming.html">Hadoop Streaming</a>
</div>
<div class="menuitem">
<a href="commands_manual.html">Hadoop Commands</a>
</div>
<div class="menuitem">
<a href="distcp.html">DistCp</a>
</div>
<div class="menupage">
<div class="menupagetitle">DistCp Version 2</div>
</div>
<div class="menuitem">
<a href="vaidya.html">Vaidya</a>
</div>
<div class="menuitem">
<a href="hadoop_archives.html">Hadoop Archives</a>
</div>
<div class="menuitem">
<a href="gridmix.html">Gridmix</a>
</div>
<div class="menuitem">
<a href="rumen.html">Rumen</a>
</div>
<div class="menuitem">
<a href="capacity_scheduler.html">Capacity Scheduler</a>
</div>
<div class="menuitem">
<a href="fair_scheduler.html">Fair Scheduler</a>
</div>
<div class="menuitem">
<a href="hod_scheduler.html">Hod Scheduler</a>
</div>
</div>
<div onclick="SwitchMenu('menu_1.4', 'skin/')" id="menu_1.4Title" class="menutitle">HDFS</div>
<div id="menu_1.4" class="menuitemgroup">
<div class="menuitem">
<a href="hdfs_user_guide.html">HDFS Users </a>
</div>
<div class="menuitem">
<a href="hdfs_design.html">HDFS Architecture</a>
</div>
<div class="menuitem">
<a href="hdfs_permissions_guide.html">Permissions</a>
</div>
<div class="menuitem">
<a href="hdfs_quota_admin_guide.html">Quotas</a>
</div>
<div class="menuitem">
<a href="SLG_user_guide.html">Synthetic Load Generator</a>
</div>
<div class="menuitem">
<a href="hdfs_imageviewer.html">Offline Image Viewer</a>
</div>
<div class="menuitem">
<a href="hftp.html">HFTP</a>
</div>
<div class="menuitem">
<a href="webhdfs.html">WebHDFS REST API</a>
</div>
<div class="menuitem">
<a href="libhdfs.html">C API libhdfs</a>
</div>
</div>
<div onclick="SwitchMenu('menu_1.5', 'skin/')" id="menu_1.5Title" class="menutitle">Common</div>
<div id="menu_1.5" class="menuitemgroup">
<div class="menuitem">
<a href="deployment_layout.html">Deployment Layout</a>
</div>
<div class="menuitem">
<a href="file_system_shell.html">File System Shell</a>
</div>
<div class="menuitem">
<a href="service_level_auth.html">Service Level Authorization</a>
</div>
<div class="menuitem">
<a href="native_libraries.html">Native Libraries</a>
</div>
</div>
<div onclick="SwitchMenu('menu_1.6', 'skin/')" id="menu_1.6Title" class="menutitle">Miscellaneous</div>
<div id="menu_1.6" class="menuitemgroup">
<div class="menuitem">
<a href="Secure_Impersonation.html">Secure Impersonation</a>
</div>
<div class="menuitem">
<a href="api/index.html">API Docs</a>
</div>
<div class="menuitem">
<a href="jdiff/changes.html">API Changes</a>
</div>
<div class="menuitem">
<a href="http://wiki.apache.org/hadoop/">Wiki</a>
</div>
<div class="menuitem">
<a href="http://wiki.apache.org/hadoop/FAQ">FAQ</a>
</div>
<div class="menuitem">
<a href="releasenotes.html">Release Notes</a>
</div>
<div class="menuitem">
<a href="changes.html">Change Log</a>
</div>
</div>
<div id="credit"></div>
<div id="roundbottom">
<img style="display: none" class="corner" height="15" width="15" alt="" src="skin/images/rc-b-l-15-1body-2menu-3menu.png"></div>
<!--+
  |alternative credits
  +-->
<div id="credit2"></div>
</div>
<!--+
    |end Menu
    +-->
<!--+
    |start content
    +-->
<div id="content">
<div title="Portable Document Format" class="pdflink">
<a class="dida" href="distcp2.pdf"><img alt="PDF -icon" src="skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a>
</div>
<h1>DistCp Version 2 Guide</h1>
<div id="front-matter">
<div id="minitoc-area">
<ul class="minitoc">
<li>
<a href="#Overview">Overview</a>
</li>
<li>
<a href="#Usage">Usage</a>
<ul class="minitoc">
<li>
<a href="#BasicUsage">Basic Usage</a>
</li>
<li>
<a href="#UpdateAndOverwrite">Update and Overwrite</a>
</li>
</ul>
</li>
<li>
<a href="#CommandLineOptions">Command Line Options</a>
</li>
<li>
<a href="#ArchitectureOfDistCp">Architecture of DistCp</a>
<ul class="minitoc">
<li>
<a href="#DistCpDriver">DistCp Driver</a>
</li>
<li>
<a href="#Copy-listingGenerator">Copy-listing Generator</a>
</li>
<li>
<a href="#Input-formatsAndMap-ReduceComponents">Input-formats and Map-Reduce Components</a>
</li>
</ul>
</li>
<li>
<a href="#Appendix">Appendix</a>
<ul class="minitoc">
<li>
<a href="#MapSizing">Map sizing</a>
</li>
<li>
<a href="#CopyingBetweenVersionsOfHDFS">Copying Between Versions of HDFS</a>
</li>
<li>
<a href="#MapReduceAndOtherSide-effects">Map/Reduce and other side-effects</a>
</li>
<li>
<a href="#SSLConfigurationsForHSFTPSources">SSL Configurations for HSFTP sources</a>
</li>
</ul>
</li>
<li>
<a href="#FrequentlyAskedQuestions">Frequently Asked Questions</a>
</li>
</ul>
</div>
</div>

    
<a name="Overview"></a>
<h2 class="h3">Overview</h2>
<div class="section">
<p>DistCp Version 2 (distributed copy) is a tool used for large inter/intra-cluster
      copying. It uses MapReduce to effect its distribution, error
      handling and recovery, and reporting. It expands a list of files and
      directories into input to map tasks, each of which will copy a partition
      of the files specified in the source list.
      </p>
<p>
       The erstwhile implementation of DistCp has its share of quirks and
       drawbacks, both in its usage, as well as its extensibility and
       performance. The purpose of the DistCp refactor was to fix these shortcomings,
       enabling it to be used and extended programmatically. New paradigms have
       been introduced to improve runtime and setup performance, while simultaneously
       retaining the legacy behaviour as default.
      </p>
<p>
       This document aims to describe the design of the new DistCp, its spanking
       new features, their optimal use, and any deviance from the legacy
       implementation.
      </p>
</div>

    
<a name="Usage"></a>
<h2 class="h3">Usage</h2>
<div class="section">
<a name="BasicUsage"></a>
<h3 class="h4">Basic Usage</h3>
<p>The most common invocation of DistCp is an inter-cluster copy:</p>
<p>
<span class="codefrag">bash$ hadoop distcp2 hdfs://nn1:8020/foo/bar \</span>
<br>
           
<span class="codefrag">                    hdfs://nn2:8020/bar/foo</span>
</p>
<p>This will expand the namespace under <span class="codefrag">/foo/bar</span> on nn1
        into a temporary file, partition its contents among a set of map
        tasks, and start a copy on each TaskTracker from nn1 to nn2.</p>
<p>One can also specify multiple source directories on the command
        line:</p>
<p>
<span class="codefrag">bash$ hadoop distcp2 hdfs://nn1:8020/foo/a \</span>
<br>
           
<span class="codefrag"> hdfs://nn1:8020/foo/b \</span>
<br>
           
<span class="codefrag"> hdfs://nn2:8020/bar/foo</span>
</p>
<p>Or, equivalently, from a file using the <span class="codefrag">-f</span> option:<br>
        
<span class="codefrag">bash$ hadoop distcp2 -f hdfs://nn1:8020/srclist \</span>
<br>
        
<span class="codefrag"> hdfs://nn2:8020/bar/foo</span>
<br>
</p>
<p>Where <span class="codefrag">srclist</span> contains<br>
        
<span class="codefrag">hdfs://nn1:8020/foo/a</span>
<br>
        
<span class="codefrag">hdfs://nn1:8020/foo/b</span>
</p>
<p>When copying from multiple sources, DistCp will abort the copy with
        an error message if two sources collide, but collisions at the
        destination are resolved per the <a href="#CommandLineOptions">options</a>
        specified. By default, files already existing at the destination are
        skipped (i.e. not replaced by the source file). A count of skipped
        files is reported at the end of each job, but it may be inaccurate if a
        copier failed for some subset of its files, but succeeded on a later
        attempt.</p>
<p>It is important that each TaskTracker can reach and communicate with
        both the source and destination file systems. For HDFS, both the source
        and destination must be running the same version of the protocol or use
        a backwards-compatible protocol; 
        see <a href="#CopyingBetweenVersionsOfHDFS">Copying Between Versions</a>.
        </p>
<p>After a copy, it is recommended that one generates and cross-checks
        a listing of the source and destination to verify that the copy was
        truly successful. Since DistCp employs both Map/Reduce and the
        FileSystem API, issues in or between any of the three could adversely
        and silently affect the copy. Some have had success running with
        <span class="codefrag">-update</span> enabled to perform a second pass, but users should
        be acquainted with its semantics before attempting this.</p>
<p>It's also worth noting that if another client is still writing to a
        source file, the copy will likely fail. Attempting to overwrite a file
        being written at the destination should also fail on HDFS. If a source
        file is (re)moved before it is copied, the copy will fail with a
        FileNotFoundException.</p>
<p>Please refer to the detailed Command Line Reference for information
        on all the options available in DistCp.</p>
<a name="UpdateAndOverwrite"></a>
<h3 class="h4">Update and Overwrite</h3>
<p>
<span class="codefrag">-update</span> is used to copy files from source that don't
        exist at the target, or have different contents. <span class="codefrag">-overwrite</span>
        overwrites target-files even if they exist at the source, or have the
        same contents.</p>
<p>
<br>Update and Overwrite options warrant special attention, since their
        handling of source-paths varies from the defaults in a very subtle manner.
        Consider a copy from <span class="codefrag">/source/first/</span> and
        <span class="codefrag">/source/second/</span> to <span class="codefrag">/target/</span>, where the source
        paths have the following contents:</p>
<p>
<span class="codefrag">hdfs://nn1:8020/source/first/1</span>
<br>
           
<span class="codefrag">hdfs://nn1:8020/source/first/2</span>
<br>
           
<span class="codefrag">hdfs://nn1:8020/source/second/10</span>
<br>
           
<span class="codefrag">hdfs://nn1:8020/source/second/20</span>
<br>
</p>
<p>
<br>When DistCp is invoked without <span class="codefrag">-update</span> or
        <span class="codefrag">-overwrite</span>, the DistCp defaults would create directories
        <span class="codefrag">first/</span> and <span class="codefrag">second/</span>, under <span class="codefrag">/target</span>.
        Thus:<br>
</p>
<p>
<span class="codefrag">distcp2 hdfs://nn1:8020/source/first hdfs://nn1:8020/source/second hdfs://nn2:8020/target</span>
</p>
<p>
<br>would yield the following contents in <span class="codefrag">/target</span>: </p>
<p>
<span class="codefrag">hdfs://nn2:8020/target/first/1</span>
<br>
           
<span class="codefrag">hdfs://nn2:8020/target/first/2</span>
<br>
           
<span class="codefrag">hdfs://nn2:8020/target/second/10</span>
<br>
           
<span class="codefrag">hdfs://nn2:8020/target/second/20</span>
<br>
</p>
<p>
<br>When either <span class="codefrag">-update</span> or <span class="codefrag">-overwrite</span> is
            specified, the <strong>contents</strong> of the source-directories
            are copied to target, and not the source directories themselves. Thus: </p>
<p>
<span class="codefrag">distcp2 -update hdfs://nn1:8020/source/first hdfs://nn1:8020/source/second hdfs://nn2:8020/target</span>
</p>
<p>
<br>would yield the following contents in <span class="codefrag">/target</span>: </p>
<p>
<span class="codefrag">hdfs://nn2:8020/target/1</span>
<br>
           
<span class="codefrag">hdfs://nn2:8020/target/2</span>
<br>
           
<span class="codefrag">hdfs://nn2:8020/target/10</span>
<br>
           
<span class="codefrag">hdfs://nn2:8020/target/20</span>
<br>
</p>
<p>
<br>By extension, if both source folders contained a file with the same
        name (say, <span class="codefrag">0</span>), then both sources would map an entry to
        <span class="codefrag">/target/0</span> at the destination. Rather than to permit this
        conflict, DistCp will abort.</p>
<p>
<br>Now, consider the following copy operation:</p>
<p>
<span class="codefrag">distcp2 hdfs://nn1:8020/source/first hdfs://nn1:8020/source/second hdfs://nn2:8020/target</span>
</p>
<p>
<br>With sources/sizes:</p>
<p>
<span class="codefrag">hdfs://nn1:8020/source/first/1     32</span>
<br>
           
<span class="codefrag">hdfs://nn1:8020/source/first/2     32</span>
<br>
           
<span class="codefrag">hdfs://nn1:8020/source/second/10   64</span>
<br>
           
<span class="codefrag">hdfs://nn1:8020/source/second/20   32</span>
<br>
</p>
<p>
<br>And destination/sizes:</p>
<p>
<span class="codefrag">hdfs://nn2:8020/target/1   32</span>
<br>
           
<span class="codefrag">hdfs://nn2:8020/target/10  32</span>
<br>
           
<span class="codefrag">hdfs://nn2:8020/target/20  64</span>
<br>
</p>
<p>
<br>Will effect: </p>
<p>
<span class="codefrag">hdfs://nn2:8020/target/1   32</span>
<br>
           
<span class="codefrag">hdfs://nn2:8020/target/2   32</span>
<br>
           
<span class="codefrag">hdfs://nn2:8020/target/10  64</span>
<br>
           
<span class="codefrag">hdfs://nn2:8020/target/20  32</span>
<br>
</p>
<p>
<br>
<span class="codefrag">1</span> is skipped because the file-length and contents match.
        <span class="codefrag">2</span> is copied because it doesn't exist at the target.
        <span class="codefrag">10</span> and <span class="codefrag">20</span> are overwritten since the contents
        don't match the source. </p>
<p>If <span class="codefrag">-update</span> is used, <span class="codefrag">1</span> is overwritten as well.</p>
</div>

    
<a name="CommandLineOptions"></a>
<h2 class="h3">Command Line Options</h2>
<div class="section">
<table class="ForrestTable" cellspacing="1" cellpadding="4">
        
<tr>
<th colspan="1" rowspan="1"> Flag </th><th colspan="1" rowspan="1"> Description </th><th colspan="1" rowspan="1"> Notes </th>
</tr>

        
<tr>
<td colspan="1" rowspan="1"><span class="codefrag">-p[rbugp]</span></td>
            <td colspan="1" rowspan="1">Preserve<br>
                r: replication number<br>
                b: block size<br>
                u: user<br>
                g: group<br>
                p: permission<br>
</td>
            <td colspan="1" rowspan="1">Modification times are not preserved. Also, when
            <span class="codefrag">-update</span> is specified, status updates will
            <strong>not</strong> be synchronized unless the file sizes
            also differ (i.e. unless the file is re-created).
            </td>
</tr>
        
<tr>
<td colspan="1" rowspan="1"><span class="codefrag">-i</span></td>
            <td colspan="1" rowspan="1">Ignore failures</td>
            <td colspan="1" rowspan="1">As explained in the Appendix, this option
            will keep more accurate statistics about the copy than the
            default case. It also preserves logs from failed copies, which
            can be valuable for debugging. Finally, a failing map will not
            cause the job to fail before all splits are attempted.
            </td>
</tr>
        
<tr>
<td colspan="1" rowspan="1"><span class="codefrag">-log &lt;logdir&gt;</span></td>
            <td colspan="1" rowspan="1">Write logs to &lt;logdir&gt;</td>
            <td colspan="1" rowspan="1">DistCp keeps logs of each file it attempts to copy as map
            output. If a map fails, the log output will not be retained if
            it is re-executed.
            </td>
</tr>
        
<tr>
<td colspan="1" rowspan="1"><span class="codefrag">-m &lt;num_maps&gt;</span></td>
            <td colspan="1" rowspan="1">Maximum number of simultaneous copies</td>
            <td colspan="1" rowspan="1">Specify the number of maps to copy data. Note that more maps
            may not necessarily improve throughput.
            </td>
</tr>
        
<tr>
<td colspan="1" rowspan="1"><span class="codefrag">-overwrite</span></td>
            <td colspan="1" rowspan="1">Overwrite destination</td>
            <td colspan="1" rowspan="1">If a map fails and <span class="codefrag">-i</span> is not specified, all the
            files in the split, not only those that failed, will be recopied.
            As discussed in the Usage documentation, it also changes
            the semantics for generating destination paths, so users should
            use this carefully.
            </td>
</tr>
        
<tr>
<td colspan="1" rowspan="1"><span class="codefrag">-update</span></td>
            <td colspan="1" rowspan="1">Overwrite if src size different from dst size</td>
            <td colspan="1" rowspan="1">As noted in the preceding, this is not a "sync"
            operation. The only criterion examined is the source and
            destination file sizes; if they differ, the source file
            replaces the destination file. As discussed in the
            Usage documentation, it also changes the semantics for
            generating destination paths, so users should use this carefully.
            </td>
</tr>
        
<tr>
<td colspan="1" rowspan="1"><span class="codefrag">-f &lt;urilist_uri&gt;</span></td>
            <td colspan="1" rowspan="1">Use list at &lt;urilist_uri&gt; as src list</td>
            <td colspan="1" rowspan="1">This is equivalent to listing each source on the command
            line. The <span class="codefrag">urilist_uri</span> list should be a fully
            qualified URI.
            </td>
</tr>
        
<tr>
<td colspan="1" rowspan="1"><span class="codefrag">-filelimit &lt;n&gt;</span></td>
            <td colspan="1" rowspan="1">Limit the total number of files to be &lt;= n</td>
            <td colspan="1" rowspan="1"><strong>Deprecated!</strong> Ignored in the new DistCp.
            </td>
</tr>
        
<tr>
<td colspan="1" rowspan="1"><span class="codefrag">-sizelimit &lt;n&gt;</span></td>
            <td colspan="1" rowspan="1">Limit the total size to be &lt;= n bytes</td>
            <td colspan="1" rowspan="1"><strong>Deprecated!</strong> Ignored in the new DistCp.
            </td>
</tr>
        
<tr>
<td colspan="1" rowspan="1"><span class="codefrag">-delete</span></td>
            <td colspan="1" rowspan="1">Delete the files existing in the dst but not in src</td>
            <td colspan="1" rowspan="1">The deletion is done by FS Shell.  So the trash will be used,
                if it is enable.
            </td>
</tr>
        
<tr>
<td colspan="1" rowspan="1"><span class="codefrag">-strategy {dynamic|uniformsize}</span></td>
            <td colspan="1" rowspan="1">Choose the copy-strategy to be used in DistCp.</td>
            <td colspan="1" rowspan="1">By default, uniformsize is used. (i.e. Maps are balanced on the
                total size of files copied by each map. Similar to legacy.)
                If "dynamic" is specified, <span class="codefrag">DynamicInputFormat</span> is
                used instead. (This is described in the Architecture section,
                under InputFormats.)
            </td>
</tr>
        
<tr>
<td colspan="1" rowspan="1"><span class="codefrag">-bandwidth</span></td>
              <td colspan="1" rowspan="1">Specify bandwidth per map, in MB/second.</td>
              <td colspan="1" rowspan="1">Each map will be restricted to consume only the specified
                  bandwidth. This is not always exact. The map throttles back
                  its bandwidth consumption during a copy, such that the
                  <strong>net</strong> bandwidth used tends towards the
                  specified value.
              </td>
</tr>
        
<tr>
<td colspan="1" rowspan="1"><span class="codefrag">-atomic {-tmp &lt;tmp_dir&gt;}</span></td>
              <td colspan="1" rowspan="1">Specify atomic commit, with optional tmp directory.</td>
              <td colspan="1" rowspan="1"><span class="codefrag">-atomic</span> instructs DistCp to copy the source
                  data to a temporary target location, and then move the
                  temporary target to the final-location atomically. Data will
                  either be available at final target in a complete and consistent
                  form, or not at all.
                  Optionally, <span class="codefrag">-tmp</span> may be used to specify the
                  location of the tmp-target. If not specified, a default is
                  chosen. <strong>Note:</strong> tmp_dir must be on the final
                  target cluster.
              </td>
</tr>
        
<tr>
<td colspan="1" rowspan="1"><span class="codefrag">-mapredSslConf &lt;ssl_conf_file&gt;</span></td>
              <td colspan="1" rowspan="1">Specify SSL Config file, to be used with HSFTP source</td>
              <td colspan="1" rowspan="1">When using the hsftp protocol with a source, the security-
                  related properties may be specified in a config-file and
                  passed to DistCp. &lt;ssl_conf_file&gt; needs to be in
                  the classpath.
              </td>
</tr>
        
<tr>
<td colspan="1" rowspan="1"><span class="codefrag">-async</span></td>
              <td colspan="1" rowspan="1">Run DistCp asynchronously. Quits as soon as the Hadoop
              Job is launched.</td>
              <td colspan="1" rowspan="1">The Hadoop Job-id is logged, for tracking.
              </td>
</tr>
      
</table>
</div>

    
<a name="ArchitectureOfDistCp"></a>
<h2 class="h3">Architecture of DistCp</h2>
<div class="section">
<p>The components of the new DistCp may be classified into the following
         categories: </p>
<ul>
        
<li>DistCp Driver</li>
        
<li>Copy-listing generator</li>
        
<li>Input-formats and Map-Reduce components</li>
      
</ul>
<a name="DistCpDriver"></a>
<h3 class="h4">DistCp Driver</h3>
<p>The DistCp Driver components are responsible for:</p>
<ul>
          
<li>Parsing the arguments passed to the DistCp command on the
              command-line, via:
            <ul>
              
<li>OptionsParser, and</li>
              
<li>DistCpOptionsSwitch</li>
            
</ul>
          
</li>
          
<li>Assembling the command arguments into an appropriate
              DistCpOptions object, and initializing DistCp. These arguments
              include:
            <ul>
              
<li>Source-paths</li>
              
<li>Target location</li>
              
<li>Copy options (e.g. whether to update-copy, overwrite, which
                  file-attributes to preserve, etc.)</li>
            
</ul>
          
</li>
          
<li>Orchestrating the copy operation by:
            <ul>
              
<li>Invoking the copy-listing-generator to create the list of
                  files to be copied.</li>
              
<li>Setting up and launching the Hadoop Map-Reduce Job to carry
                  out the copy.</li>
              
<li>Based on the options, either returning a handle to the
                  Hadoop MR Job immediately, or waiting till completion.</li>
            
</ul>
          
</li>
        
</ul>
<p>The parser-elements are exercised only from the command-line (or if
           DistCp::run() is invoked). The DistCp class may also be used
           programmatically, by constructing the DistCpOptions object, and
           initializing a DistCp object appropriately.</p>
<a name="Copy-listingGenerator"></a>
<h3 class="h4">Copy-listing Generator</h3>
<p>The copy-listing-generator classes are responsible for creating the
           list of files/directories to be copied from source. They examine
           the contents of the source-paths (files/directories, including
           wild-cards), and record all paths that need copy into a sequence-
           file, for consumption by the DistCp Hadoop Job. The main classes in
           this module include:</p>
<ol>
          
<li>CopyListing: The interface that should be implemented by any 
              copy-listing-generator implementation. Also provides the factory
              method by which the concrete CopyListing implementation is
              chosen.</li>

          
<li>SimpleCopyListing: An implementation of CopyListing that accepts
              multiple source paths (files/directories), and recursively lists
              all the individual files and directories under each, for
              copy.</li>

          
<li>GlobbedCopyListing: Another implementation of CopyListing that
              expands wild-cards in the source paths.</li>

          
<li>FileBasedCopyListing: An implementation of CopyListing that
              reads the source-path list from a specified file.</li>
        
</ol>
<p>Based on whether a source-file-list is specified in the
           DistCpOptions, the source-listing is generated in one of the
           following ways:</p>
<ol>
          
<li>If there's no source-file-list, the GlobbedCopyListing is used.
              All wild-cards are expanded, and all the expansions are
              forwarded to the SimpleCopyListing, which in turn constructs the
              listing (via recursive descent of each path). </li>

          
<li>If a source-file-list is specified, the FileBasedCopyListing is
              used. Source-paths are read from the specified file, and then
              forwarded to the GlobbedCopyListing. The listing is then
              constructed as described above.</li>
        
</ol>
<p>One may customize the method by which the copy-listing is
           constructed by providing a custom implementation of the CopyListing
           interface. The behaviour of DistCp differs here from the legacy
           DistCp, in how paths are considered for copy. </p>
<p>The legacy implementation only lists those paths that must
           definitely be copied on to target.
           E.g. if a file already exists at the target (and -overwrite isn't
           specified), the file isn't even considered in the Map-Reduce Copy
           Job. Determining this during setup (i.e. before the Map-Reduce Job)
           involves file-size and checksum-comparisons that are potentially
           time-consuming.</p>
<p>The new DistCp postpones such checks until the Map-Reduce Job, thus
           reducing setup time. Performance is enhanced further since these
           checks are parallelized across multiple maps.</p>
<a name="Input-formatsAndMap-ReduceComponents"></a>
<h3 class="h4">Input-formats and Map-Reduce Components</h3>
<p> The Input-formats and Map-Reduce components are responsible for
            the actual copy of files and directories from the source to the
            destination path. The listing-file created during copy-listing
            generation is consumed at this point, when the copy is carried
            out. The classes of interest here include:</p>
<ul>
          
<li>
<strong>UniformSizeInputFormat:</strong> This implementation of
              org.apache.hadoop.mapreduce.InputFormat provides equivalence
              with Legacy DistCp in balancing load across maps.
              The aim of the UniformSizeInputFormat is to make each map copy
              roughly the same number of bytes. Apropos, the listing file is
              split into groups of paths, such that the sum of file-sizes in
              each InputSplit is nearly equal to every other map. The splitting
              isn't always perfect, but its trivial implementation keeps the
              setup-time low.</li>

          
<li>
<strong>DynamicInputFormat and DynamicRecordReader:</strong>
              
<p> The DynamicInputFormat implements org.apache.hadoop.mapreduce.InputFormat,
              and is new to DistCp. The listing-file is split into several
              "chunk-files", the exact number of chunk-files being a multiple
              of the number of maps requested for in the Hadoop Job. Each map
              task is "assigned" one of the chunk-files (by renaming the chunk
              to the task's id), before the Job is launched.</p>

              
<p>Paths are read from each chunk using the DynamicRecordReader,
              and processed in the CopyMapper. After all the paths in a chunk
              are processed, the current chunk is deleted and a new chunk is
              acquired. The process continues until no more chunks are
              available.</p>
              
<p>This "dynamic" approach allows faster map-tasks to consume
              more paths than slower ones, thus speeding up the DistCp job
              overall. </p>
          
</li>

          
<li>
<strong>CopyMapper:</strong> This class implements the physical
              file-copy. The input-paths are checked against the input-options
              (specified in the Job's Configuration), to determine whether a
              file needs copy. A file will be copied only if at least one of
              the following is true:
            <ul>
              
<li>A file with the same name doesn't exist at target.</li>
              
<li>A file with the same name exists at target, but has a
                  different file size.</li>
              
<li>A file with the same name exists at target, but has a
                  different checksum, and -skipcrccheck isn't mentioned.</li>
              
<li>A file with the same name exists at target, but -overwrite
                  is specified.</li>
              
<li>A file with the same name exists at target, but differs in
                  block-size (and block-size needs to be preserved.</li>
            
</ul>
          
</li>

          
<li>
<strong>CopyCommitter:</strong>
              This class is responsible for the commit-phase of the DistCp
              job, including:
            <ul>
              
<li>Preservation of directory-permissions (if specified in the
                  options)</li>
              
<li>Clean-up of temporary-files, work-directories, etc.</li>
            
</ul>
          
</li>
        
</ul>
</div>

    
<a name="Appendix"></a>
<h2 class="h3">Appendix</h2>
<div class="section">
<a name="MapSizing"></a>
<h3 class="h4">Map sizing</h3>
<p> By default, DistCp makes an attempt to size each map comparably so
        that each copies roughly the same number of bytes. Note that files are the
        finest level of granularity, so increasing the number of simultaneous
        copiers (i.e. maps) may not always increase the number of
        simultaneous copies nor the overall throughput.</p>
<p> The new DistCp also provides a strategy to "dynamically" size maps,
        allowing faster data-nodes to copy more bytes than slower nodes. Using
        <span class="codefrag">-strategy dynamic</span> (explained in the Architecture), rather
        than to assign a fixed set of source-files to each map-task, files are
        instead split into several sets. The number of sets exceeds the number of
        maps, usually by a factor of 2-3. Each map picks up and copies all files
        listed in a chunk. When a chunk is exhausted, a new chunk is acquired and
        processed, until no more chunks remain.</p>
<p> By not assigning a source-path to a fixed map, faster map-tasks (i.e.
        data-nodes) are able to consume more chunks, and thus copy more data,
        than slower nodes. While this distribution isn't uniform, it is
        <strong>fair</strong> with regard to each mapper's capacity.</p>
<p>The dynamic-strategy is implemented by the DynamicInputFormat. It
        provides superior performance under most conditions. </p>
<p>Tuning the number of maps to the size of the source and
        destination clusters, the size of the copy, and the available
        bandwidth is recommended for long-running and regularly run jobs.</p>
<a name="CopyingBetweenVersionsOfHDFS"></a>
<h3 class="h4">Copying Between Versions of HDFS</h3>
<p>For copying between two different versions of Hadoop, one will
        usually use HftpFileSystem. This is a read-only FileSystem, so DistCp
        must be run on the destination cluster (more specifically, on
        TaskTrackers that can write to the destination cluster). Each source is
        specified as <span class="codefrag">hftp://&lt;dfs.http.address&gt;/&lt;path&gt;</span>
        (the default <span class="codefrag">dfs.http.address</span> is
        &lt;namenode&gt;:50070).</p>
<a name="MapReduceAndOtherSide-effects"></a>
<h3 class="h4">Map/Reduce and other side-effects</h3>
<p>As has been mentioned in the preceding, should a map fail to copy
        one of its inputs, there will be several side-effects.</p>
<ul>
          
<li>Unless <span class="codefrag">-overwrite</span> is specified, files successfully
          copied by a previous map on a re-execution will be marked as
          "skipped".</li>

          
<li>If a map fails <span class="codefrag">mapred.map.max.attempts</span> times, the
          remaining map tasks will be killed (unless <span class="codefrag">-i</span> is
          set).</li>

          
<li>If <span class="codefrag">mapred.speculative.execution</span> is set set
          <span class="codefrag">final</span> and <span class="codefrag">true</span>, the result of the copy is
          undefined.</li>
        
</ul>
<a name="SSLConfigurationsForHSFTPSources"></a>
<h3 class="h4">SSL Configurations for HSFTP sources</h3>
<p>To use an HSFTP source (i.e. using the hsftp protocol), a Map-Red SSL
        configuration file needs to be specified (via the <span class="codefrag">-mapredSslConf</span>
        option). This must specify 3 parameters:</p>
<ul>
          
<li>
<span class="codefrag">ssl.client.truststore.location</span>: The local-filesystem
           location of the trust-store file, containing the certificate for
           the namenode.</li>

          
<li>
<span class="codefrag">ssl.client.truststore.type</span>: (Optional) The format of
          the trust-store file.</li>

          
<li>
<span class="codefrag">ssl.client.truststore.password</span>: (Optional) Password
          for the trust-store file.</li>
        
</ul>
<p>The following is an example of the contents of the contents of
        a Map-Red SSL Configuration file:</p>
<p> 
<br> 
<span class="codefrag"> &lt;configuration&gt; </span> 
</p>
<p> 
<br> 
<span class="codefrag">&lt;property&gt; </span> 
</p>
<p> 
<span class="codefrag">&lt;name&gt;ssl.client.truststore.location&lt;/name&gt; </span> 
</p>
<p> 
<span class="codefrag">&lt;value&gt;/work/keystore.jks&lt;/value&gt; </span> 
</p>
<p> 
<span class="codefrag">&lt;description&gt;Truststore to be used by clients like distcp. Must be specified. &lt;/description&gt;</span> 
</p>
<p> 
<br> 
<span class="codefrag">&lt;/property&gt; </span> 
</p>
<p>
<span class="codefrag"> &lt;property&gt; </span> 
</p>
<p> 
<span class="codefrag">&lt;name&gt;ssl.client.truststore.password&lt;/name&gt; </span> 
</p>
<p> 
<span class="codefrag">&lt;value&gt;changeme&lt;/value&gt; </span> 
</p>
<p> 
<span class="codefrag">&lt;description&gt;Optional. Default value is "". &lt;/description&gt;  </span> 
</p>
<p> 
<span class="codefrag">&lt;/property&gt; </span>  
</p>
<p> 
<br> 
<span class="codefrag"> &lt;property&gt; </span> 
</p>
<p> 
<span class="codefrag"> &lt;name&gt;ssl.client.truststore.type&lt;/name&gt;</span>  
</p>
<p> 
<span class="codefrag"> &lt;value&gt;jks&lt;/value&gt;</span>  
</p>
<p> 
<span class="codefrag"> &lt;description&gt;Optional. Default value is "jks". &lt;/description&gt;</span>  
</p>
<p> 
<span class="codefrag"> &lt;/property&gt; </span> 
</p>
<p> 
<span class="codefrag"> &lt;/configuration&gt; </span> 
</p>
<p>
<br>The SSL configuration file must be in the class-path of the 
        DistCp program.</p>
</div>

    
<a name="FrequentlyAskedQuestions"></a>
<h2 class="h3">Frequently Asked Questions</h2>
<div class="section">
<ol>
      
<li>
<strong>Why does -update not create the parent source-directory under
          a pre-existing target directory?</strong>

        
<p>The behaviour of <span class="codefrag">-update</span> and <span class="codefrag">-overwrite</span>
        is described in detail in the Usage section of this document. In short,
        if either option is used with a pre-existing destination directory, the
        <strong>contents</strong> of each source directory is copied over, rather
        than the source-directory itself.
        This behaviour is consistent with the legacy DistCp implementation as well.
        </p>
      
</li>

      
<li>
<strong>How does the new DistCp differ in semantics from the Legacy
      DistCp?</strong>

        
<ul>
          
<li>Files that are skipped during copy used to also have their
          file-attributes (permissions, owner/group info, etc.) unchanged,
          when copied with Legacy DistCp. These are now updated, even if
          the file-copy is skipped.</li>
          
<li>Empty root directories among the source-path inputs were not
          created at the target, in Legacy DistCp. These are now created.</li>
        
</ul>
      
</li>

      
<li>
<strong>Why does the new DistCp use more maps than legacy DistCp?</strong>
        
<p>Legacy DistCp works by figuring out what files need to be actually
        copied to target <strong>before</strong> the copy-job is launched, and then
        launching as many maps as required for copy. So if a majority of the files
        need to be skipped (because they already exist, for example), fewer maps
        will be needed. As a consequence, the time spent in setup (i.e. before the
        M/R job) is higher.</p>
        
<p>The new DistCp calculates only the contents of the source-paths. It
        doesn't try to filter out what files can be skipped. That decision is put-
        off till the M/R job runs. This is much faster (vis-a-vis execution-time),
        but the number of maps launched will be as specified in the <span class="codefrag">-m</span>
        option, or 20 (default) if unspecified.</p>
      
</li>

      
<li>
<strong>Why does DistCp not run faster when more maps are specified?</strong>
        
<p>At present, the smallest unit of work for DistCp is a file. i.e.,
        a file is processed by only one map. Increasing the number of maps to
        a value exceeding the number of files would yield no performance
        benefit. The number of maps lauched would equal the number of files.</p>
      
</li>

      
<li>
<strong>Why does DistCp run out of memory?</strong>
        
<p>If the number of individual files/directories being copied from
        the source path(s) is extremely large (e.g. 1,000,000 paths), DistCp might
        run out of memory while determining the list of paths for copy. This is
        not unique to the new DistCp implementation.</p>
        
<p>To get around this, consider changing the <span class="codefrag">-Xmx</span> JVM
        heap-size parameters, as follows:</p>
        
<p>
<span class="codefrag">bash$ export HADOOP_CLIENT_OPTS="-Xms64m -Xmx1024m"</span>
</p>
        
<p>
<span class="codefrag">bash$ hadoop distcp2 /source /target</span>
</p>
      
</li>
    
</ol>
</div>

  
</div>
<!--+
    |end content
    +-->
<div class="clearboth">&nbsp;</div>
</div>
<div id="footer">
<!--+
    |start bottomstrip
    +-->
<div class="lastmodified">
<script type="text/javascript"><!--
document.write("Last Published: " + document.lastModified);
//  --></script>
</div>
<div class="copyright">
        Copyright &copy;
         2008 <a href="http://www.apache.org/licenses/">The Apache Software Foundation.</a>
</div>
<!--+
    |end bottomstrip
    +-->
</div>
</body>
</html>
